/*
THIS IS A GENERATED/BUNDLED FILE BY ESBUILD
if you want to view the source, please visit the github repository of this plugin
*/

var Pt=Object.create;var se=Object.defineProperty;var _t=Object.getOwnPropertyDescriptor;var It=Object.getOwnPropertyNames;var Rt=Object.getPrototypeOf,wt=Object.prototype.hasOwnProperty;var Dt=(a,e)=>{for(var t in e)se(a,t,{get:e[t],enumerable:!0})},Ve=(a,e,t,r)=>{if(e&&typeof e=="object"||typeof e=="function")for(let i of It(e))!wt.call(a,i)&&i!==t&&se(a,i,{get:()=>e[i],enumerable:!(r=_t(e,i))||r.enumerable});return a};var we=(a,e,t)=>(t=a!=null?Pt(Rt(a)):{},Ve(e||!a||!a.__esModule?se(t,"default",{value:a,enumerable:!0}):t,a)),Ot=a=>Ve(se({},"__esModule",{value:!0}),a);var Gt={};Dt(Gt,{default:()=>Ie});module.exports=Ot(Gt);var Mt=require("obsidian");var De=require("obsidian");var re=require("obsidian"),ae=class extends re.Modal{constructor(e,t,r){super(e),this.folderName=t,this.folderPath=r,this.result=!1,this.modalPromise=new Promise(i=>{this.resolveModalPromise=i})}onOpen(){let{contentEl:e}=this;e.createEl("h2",{text:`[ChatGPT MD] No ${this.folderName} folder found.`}),e.createEl("p",{text:`If you choose "Yes, Create", the plugin will automatically create a folder at: ${this.folderPath}. You can change this path in the plugin settings.`}),new re.Setting(e).addButton(t=>t.setButtonText("Yes, Create Folder").setTooltip("Create folder").setCta().onClick(()=>{this.result=!0,this.resolveModalPromise(this.result),this.close()})),new re.Setting(e).addButton(t=>t.setButtonText("No, I'll create it myself").setTooltip("Cancel").setCta().onClick(()=>{this.result=!1,this.resolveModalPromise(this.result),this.close()}))}waitForModalValue(){return this.modalPromise}onClose(){let{contentEl:e}=this;e.empty()}};var Ke=async(a,e,t)=>{let r=new ae(a,e,t);r.open();let i=await r.waitForModalValue();return i&&await a.vault.createFolder(t),i};var z=class{constructor(e){this.app=e}async writeInferredTitle(e,t){var s,l;let r=e.file;if(!r)throw new Error("No file is currently open");let i=this.sanitizeFileName(t),n=(l=(s=r.parent)==null?void 0:s.path)!=null?l:"/",o=`${n}/${i}.md`;for(let c=1;await this.app.vault.adapter.exists(o);c++)o=`${n}/${i} (${c}).md`;try{await this.app.fileManager.renameFile(r,o)}catch(c){throw new De.Notice("[ChatGPT MD] Error writing inferred title to editor"),c}}sanitizeFileName(e){return e.replace(/[\\/:*?"<>|]/g,"-")}async ensureFolderExists(e,t){return!await this.app.vault.adapter.exists(e)&&!await Ke(this.app,t,e)?(new De.Notice(`[ChatGPT MD] No ${t} found. One must be created to use the plugin. Set one in settings and make sure it exists.`),!1):!0}async createNewFile(e,t){return this.app.vault.create(e,t)}async readFile(e){return this.app.vault.read(e)}async getLinkedNoteContent(e){try{let t=this.app.metadataCache.getFirstLinkpathDest(e,"");return t?await this.app.vault.read(t):null}catch(t){return null}}formatDate(e,t){return e.toISOString().replace(/[-:]/g,"").replace(/\..+/,"")}};var pt=require("obsidian");var g="ollama",d="openai",u="openrouter",f="lmstudio",S="anthropic",v="gemini",He={[d]:"/v1/chat/completions",[u]:"/api/v1/chat/completions",[g]:"/api/chat",[f]:"/v1/chat/completions",[S]:"/v1/messages",[v]:"/v1beta/models/{model}:generateContent"},qe="add-comment-block",Be="add-hr",je="call-chatgpt-api",We="stop-streaming",Ye="move-to-chat",ze="infer-title",Je="choose-chat-template",Xe="clear-chat";var Oe="chatFolder",Ze="chatTemplateFolder",D=`

`,Qe=/\[\[([^\][]+)\]\]/g,et=/\[([^\]]+)\]\(([^()]+)\)/g,tt=`=begin-chatgpt-md-comment${D}`,rt="=end-chatgpt-md-comment",it=3,Ne=6,nt="English",ot=4,le="YYYYMMDDhhmmss",st="Failed to fetch",Fe="__chatgpt_plugin",ie=`<hr class="${Fe}">`,V="role::",x="assistant",be="developer",U="system",N="user",Y=6e3,ce="You're chatting with a user in Obsidian, a knowledge management system where they organize notes in interconnected Markdown files. This conversation appears as a chat within their active document.\n\nBe helpful and concise. Use proper Markdown: ```language for code blocks, `inline` for code/filenames. Support [[Internal Links]] and [external links](url). Consider this chat is part of their personal knowledge base.\n\nWhen appropriate, end with an open question to keep the conversation helpful and make contextual offers based on their last message.",xe="\u26A0\uFE0F **Response was truncated due to token limit.** Please increase the `max_tokens` setting in ChatGPT MD plugin settings to get the complete response.",Le="\u26A0\uFE0F *Note: Some alternative responses were truncated due to token limit. Consider increasing `max_tokens` in settings for fuller responses.*",at="Response was truncated due to token limit",lt="\u26A0\uFE0F Title Inference Error";var Nt=a=>{let e=a.replace(/[-/\\^$*+?.()|[\]{}]/g,"\\$&").replace("YYYY","\\d{4}").replace("MM","\\d{2}").replace("DD","\\d{2}").replace("hh","\\d{2}").replace("mm","\\d{2}").replace("ss","\\d{2}");return new RegExp(`^${e}$`)},ct=(a="",e)=>(a==null?void 0:a.length)==e.length&&Nt(e).test(a),K=a=>a===0?"":a>Ne?"#".repeat(Ne)+" ":"#".repeat(a)+" ",G=(a,e,t)=>`${D}${ie}${D}${a}${V}${e}${t?`<span style="font-size: small;"> (${t})</span>`:""}${D}`,Ge=a=>{let t=a.replace(/^---\n/,"").replace(/\n---$/,"").split(`
`),r={},i=null,n=[];for(let o=0;o<t.length;o++){let s=t[o].trim();if(!s)continue;if(i!==null)if(s.startsWith("-")){let m=s.substring(1).trim();(m.startsWith("'")&&m.endsWith("'")||m.startsWith('"')&&m.endsWith('"'))&&(m=m.substring(1,m.length-1)),n.push(m);continue}else r[i]=n,i=null,n=[];let l=s.indexOf(":");if(l===-1)continue;let c=s.substring(0,l).trim(),p=s.substring(l+1).trim();if(p===""&&o+1<t.length&&t[o+1].trim().startsWith("-")){i=c,n=[];continue}p.startsWith("[")&&p.endsWith("]")?r[c]=p.slice(1,-1).split(",").map(m=>{let T=m.trim();return T.startsWith("'")&&T.endsWith("'")||T.startsWith('"')&&T.endsWith('"')?T.slice(1,-1):T}):p==="true"?r[c]=!0:p==="false"?r[c]=!1:p==="null"?r[c]=null:isNaN(Number(p))?r[c]=p:r[c]=Number(p)}return i!==null&&(r[i]=n),r};var J=class{constructor(e){this.app=e}async readFrontmatter(e){try{let t=this.app.metadataCache.getFileCache(e);return t!=null&&t.frontmatter?{...t.frontmatter}:null}catch(t){return null}}async writeFrontmatter(e,t){try{await this.app.fileManager.processFrontMatter(e,r=>{Object.keys(r).forEach(i=>{delete r[i]}),Object.assign(r,t)})}catch(r){throw new Error(`Failed to write frontmatter: ${r.message}`)}}async updateFrontmatterField(e,t,r){try{await this.app.fileManager.processFrontMatter(e,i=>{i[t]=r})}catch(i){throw new Error(`Failed to update frontmatter field '${t}': ${i.message}`)}}async mergeFrontmatter(e,t){try{await this.app.fileManager.processFrontMatter(e,r=>{Object.assign(r,t)})}catch(r){throw new Error(`Failed to merge frontmatter: ${r.message}`)}}hasFrontmatter(e){try{let t=this.app.metadataCache.getFileCache(e);return!!(t!=null&&t.frontmatter&&Object.keys(t.frontmatter).length>0)}catch(t){return!1}}async removeFrontmatterField(e,t){try{await this.app.fileManager.processFrontMatter(e,r=>{delete r[t]})}catch(r){throw new Error(`Failed to remove frontmatter field '${t}': ${r.message}`)}}async removeFrontmatterFields(e,t){try{await this.app.fileManager.processFrontMatter(e,r=>{t.forEach(i=>{delete r[i]})})}catch(r){throw new Error(`Failed to remove frontmatter fields: ${r.message}`)}}async clearFrontmatter(e){try{await this.app.fileManager.processFrontMatter(e,t=>{Object.keys(t).forEach(r=>{delete t[r]})})}catch(t){throw new Error(`Failed to clear frontmatter: ${t.message}`)}}async getFrontmatterField(e,t,r){try{let i=await this.readFrontmatter(e);return!i||!(t in i)?r:i[t]}catch(i){return r}}async hasFrontmatterField(e,t){try{let r=await this.readFrontmatter(e);return!!(r&&t in r)}catch(r){return!1}}};var X=class{constructor(e){this.app=e;e&&(this.frontmatterManager=new J(e))}addHorizontalRule(e,t,r){let i=`${D}<hr class="${Fe}">${D}${K(r)}${V}${t}${D}`,n=e.getCursor();e.replaceRange(i,n),e.setCursor(n.line+i.split(`
`).length-1,0)}appendMessage(e,t,r){let i=K(r),n=G(i,x),o=G(i,N);e.replaceRange(`${n}${t}${o}`,e.getCursor())}async clearChat(e){let t="";if(this.app&&this.frontmatterManager){let r=this.app.workspace.getActiveViewOfType(pt.MarkdownView);if(r!=null&&r.file)try{let i=await this.frontmatterManager.readFrontmatter(r.file);if(i&&Object.keys(i).length>0){let n=Object.entries(i).filter(([o])=>o!=="position").map(([o,s])=>typeof s=="string"?`${o}: "${s}"`:`${o}: ${s}`);n.length>0&&(t=`---
${n.join(`
`)}
---

`)}}catch(i){}}e.setValue(t),t?e.setCursor({line:e.lastLine()+1,ch:0}):e.setCursor({line:0,ch:0})}moveCursorToEnd(e){try{let r={line:e.lastLine()+1,ch:0};e.setCursor(r)}catch(t){throw new Error("Error moving cursor to end of file"+t)}}addCommentBlock(e,t,r){let i=e.getCursor(),n=`${t}${D}${r}`;e.replaceRange(n,i),e.setCursor({line:i.line+1,ch:i.ch})}};var Z=class{constructor(e,t){this.fileService=e;this.notificationService=t}findLinksInMessage(e){let t=[{regex:Qe,fullMatchIndex:0,titleIndex:1},{regex:et,fullMatchIndex:0,titleIndex:2}],r=[],i=new Set;for(let{regex:n,fullMatchIndex:o,titleIndex:s}of t)for(let l of e.matchAll(n)){let c=l[o],p=l[s];p&&!i.has(p)&&!p.startsWith("http://")&&!p.startsWith("https://")&&(r.push({link:c,title:p}),i.add(p))}return r}splitMessages(e){return e?e.split(ie):[]}removeYAMLFrontMatter(e){if(!e||!e.trim().startsWith("---"))return e;let t=e.split(`
`),r=-1;for(let i=1;i<t.length;i++)if(t[i].trim()==="---"){r=i;break}return r===-1?e:t.slice(r+1).join(`
`).trim()}removeCommentsFromMessages(e){try{let t=/=begin-chatgpt-md-comment[\s\S]*?=end-chatgpt-md-comment/g;return e.replace(t,"")}catch(t){return this.notificationService.showError("Error removing comments from messages: "+t),e}}extractRoleAndMessage(e){try{if(!e.includes(V))return{role:N,content:e};let[t,...r]=e.split(V)[1].split(`
`);return{role:this.cleanupRole(t),content:r.join(`
`).trim()}}catch(t){return this.notificationService.showError("Failed to extract role and message: "+t),{role:N,content:e}}}cleanupRole(e){let t=e.trim().toLowerCase(),i=[N,x].find(n=>t.includes(n));return i||(this.notificationService.showWarning(`Unknown role: "${e}", defaulting to user`),N)}cleanMessagesFromNote(e){return this.splitMessages(this.removeYAMLFrontMatter(e.getValue())).map(r=>this.removeCommentsFromMessages(r))}async getMessagesFromEditor(e,t){let r=this.cleanMessagesFromNote(e);r=await Promise.all(r.map(async n=>{let o=this.findLinksInMessage(n);for(let s of o)try{let l=await this.fileService.getLinkedNoteContent(s.title);if(l){let c=new RegExp(`${D}${ie}${D}#+ ${V}(?:${N}|${x}).*$`,"gm");l=l==null?void 0:l.replace(c,""),l=this.removeYAMLFrontMatter(l)||null,n=n.replace(new RegExp(this.escapeRegExp(s.link),"g"),`${D}${s.title}${D}${l}${D}`)}}catch(l){}return n}));let i=r.map(n=>this.extractRoleAndMessage(n));return{messages:r,messagesWithRole:i}}addSystemCommandsToMessages(e,t){return!t||t.length===0?e:[...t.map(i=>({role:"system",content:i})),...e]}formatMessage(e,t,r){let i=K(t);return`${G(i,e.role,r)}${e.content}`}appendMessage(e,t,r){let i=K(r),n=G(i,x),o=G(i,N);e.replaceRange(`${n}${t}${o}`,e.getCursor())}processResponse(e,t,r){t.mode==="streaming"?t.wasAborted||this.processStreamingResponse(e,r):this.processStandardResponse(e,t,r)}processStreamingResponse(e,t){let r=K(t.headingLevel),i=G(r,N),n=e.getCursor();e.replaceRange(i,n);let o=e.offsetToPos(e.posToOffset(n)+i.length);e.setCursor(o)}processStandardResponse(e,t,r){let i=typeof t=="object"&&t.fullString||t,n=typeof t=="object"?t.model:void 0,o=K(r.headingLevel),s=G(o,x,n),l=G(o,N),c=e.getCursor(),p=`${s}${i}${l}`;e.replaceRange(p,c);let m=e.offsetToPos(e.posToOffset(c)+p.length);e.setCursor(m)}escapeRegExp(e){return e.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}};var B=require("obsidian");var W=require("obsidian"),pe=class extends W.SuggestModal{constructor(e,t,r){super(e),this.settings=t,this.titleDate=r}getFilesInChatFolder(){let e=this.app.vault.getAbstractFileByPath(this.settings.chatTemplateFolder);if(e!=null)return e.children;throw new W.Notice(`Error getting folder: ${this.settings.chatTemplateFolder}`),new Error(`Error getting folder: ${this.settings.chatTemplateFolder}`)}getSuggestions(e){let t=this.getFilesInChatFolder();return e==""?t.map(r=>({title:r.basename,file:r})).sort((r,i)=>r.title.localeCompare(i.title)):t.filter(r=>r.basename.toLowerCase().includes(e.toLowerCase())).map(r=>({title:r.basename,file:r})).sort((r,i)=>r.title.localeCompare(i.title))}renderSuggestion(e,t){t.createEl("div",{text:e.title})}async onChooseSuggestion(e,t){new W.Notice(`Selected ${e.title}`);let r=await this.app.vault.read(e.file),i=r;!/^---\n[\s\S]*?\n---/.test(r)&&this.settings.defaultChatFrontmatter&&(i=this.settings.defaultChatFrontmatter+`

`+r);let o=`${this.titleDate} ${e.title}`,s=(0,W.normalizePath)(`${this.settings.chatFolder}/${o}.md`),l=1;for(;await this.app.vault.adapter.exists(s);)s=(0,W.normalizePath)(`${this.settings.chatFolder}/${o} (${l}).md`),l++;try{let c=await this.app.vault.create(s,i);await this.app.workspace.openLinkText(c.basename,"",!0)}catch(c){}}};var Q=class{constructor(e,t,r){this.app=e;this.fileService=t;this.editorContentService=r}async createNewChatFromTemplate(e,t){try{if(!e.chatFolder||e.chatFolder.trim()===""){new B.Notice("[ChatGPT MD] No chat folder value found. Please set one in settings.");return}if(!e.chatTemplateFolder||e.chatTemplateFolder.trim()===""){new B.Notice("[ChatGPT MD] No chat template folder value found. Please set one in settings.");return}if(!await this.fileService.ensureFolderExists(e.chatFolder,Oe)||!await this.fileService.ensureFolderExists(e.chatTemplateFolder,Ze))return;new pe(this.app,e,t).open()}catch(r){new B.Notice("[ChatGPT MD] Error in Create new chat from template, check console")}}async createNewChatWithHighlightedText(e,t){try{let r=e.getSelection();if(!t.chatFolder||t.chatFolder.trim()===""){new B.Notice("[ChatGPT MD] No chat folder value found. Please set one in settings.");return}if(!await this.fileService.ensureFolderExists(t.chatFolder,Oe))return;let n=`${this.fileService.formatDate(new Date,t.dateFormat)}.md`,o=`${t.chatFolder}/${n}`,s="";t.defaultChatFrontmatter&&(s=t.defaultChatFrontmatter+`

`),r&&(s+=r);let l=await this.fileService.createNewFile(o,s);await this.app.workspace.openLinkText(l.basename,"",!0,{state:{mode:"source"}});let c=this.app.workspace.getActiveViewOfType(B.MarkdownView);if(!c){new B.Notice("No active markdown editor found.");return}c.editor.focus(),this.editorContentService.moveCursorToEnd(c.editor)}catch(r){new B.Notice("[ChatGPT MD] Error in Create new chat with highlighted text, check console")}}};var Ct=require("obsidian");var Ue=require("obsidian");var mt=require("obsidian"),F=class{showNotification(e,t=5e3){new mt.Notice(e,t)}formatChatMessage(e,t=!1){return t?`I am sorry. ${e}`:e}showSuccess(e){this.showNotification(`\u2705 ${e}`,3e3)}showWarning(e){this.showNotification(`\u26A0\uFE0F ${e}`,5e3)}showError(e){this.showNotification(`\u274C ${e}`,7e3)}};function w(a){return!!a&&a.trim()!==""}var y=class{constructor(e){this.notificationService=e||new F}getApiKey(e,t){switch(t){case d:return e.apiKey;case u:return e.openrouterApiKey;case S:return e.anthropicApiKey;case v:return e.geminiApiKey;case g:return"";case f:return"";default:return""}}validateApiKey(e,t){if(!(t===g||t===f)&&!w(e)){let r=`${t} API key is missing or invalid. Please add your ${t} API key in the settings or set your default model in the settings if you use Ollama or LM Studio.`;throw this.notificationService.showError(r),new Error(r)}}createAuthHeaders(e,t){let r={"Content-Type":"application/json"};switch(t){case d:r.Authorization=`Bearer ${e}`;break;case u:r.Authorization=`Bearer ${e}`,r["HTTP-Referer"]="https://github.com/bramses/chatgpt-md",r["X-Title"]="Obsidian ChatGPT MD Plugin";break;case S:r["x-api-key"]=e,r["anthropic-version"]="2023-06-01";break;case v:r["x-goog-api-key"]=e;break;case g:break;case f:break}return r}};var O=class{constructor(e){this.collectedCitations=new Set;this.contentBuffer="";this.flushInterval=null;this.FLUSH_INTERVAL_MS=200;this.editor=null;this.cursorPosition=null;this.setAtCursor=!1;this.isFlushing=!1;this.notificationService=e||new F}startFlushTimer(e,t,r){this.editor=e,this.cursorPosition=t,this.setAtCursor=r||!1,this.flushInterval&&clearInterval(this.flushInterval),this.flushInterval=setInterval(()=>{this.flushBuffer()},this.FLUSH_INTERVAL_MS)}flushBuffer(){if(!(this.isFlushing||!this.contentBuffer||!this.editor||!this.cursorPosition))try{if(this.isFlushing=!0,this.setAtCursor)this.editor.replaceSelection(this.contentBuffer);else try{this.editor.replaceRange(this.contentBuffer,this.cursorPosition);let t=this.editor.posToOffset(this.cursorPosition)+this.contentBuffer.length;this.cursorPosition=this.editor.offsetToPos(t),this.editor.setCursor(this.cursorPosition)}catch(e){return}this.contentBuffer=""}finally{this.isFlushing=!1}}stopFlushTimer(){this.flushInterval&&(clearInterval(this.flushInterval),this.flushInterval=null),this.flushBuffer(),this.editor&&this.cursorPosition&&!this.setAtCursor&&this.editor.setCursor(this.cursorPosition),this.editor=null,this.setAtCursor=!1,this.isFlushing=!1}resetBufferState(){this.contentBuffer="",this.flushInterval&&(clearInterval(this.flushInterval),this.flushInterval=null),this.editor=null,this.cursorPosition=null,this.setAtCursor=!1,this.isFlushing=!1}addToBuffer(e){this.contentBuffer+=e}handleChoicesWithFinishReason(e){var i,n;if(!e||e.length===0)return null;let t=e.filter(o=>o.finish_reason==="stop"),r=e.filter(o=>o.finish_reason==="length");if(t.length>0){let o=((i=t[0].message)==null?void 0:i.content)||"";return r.length>0?o+`

`+Le:o}return r.length>0?xe:((n=e[0].message)==null?void 0:n.content)||""}insertAssistantHeader(e,t,r){let i=G(t,x,r),n=e.getCursor();e.replaceRange(i,n);let o=e.posToOffset(n),s=e.offsetToPos(o+i.length);return e.setCursor(s),{initialCursor:n,newCursor:s}}parseNonStreamingResponse(e,t){switch(t){case d:case u:case f:let r=this.handleChoicesWithFinishReason(e.choices);return r!==null?r:"";case S:return e.content&&Array.isArray(e.content)?e.content.filter(n=>n.type==="text").map(n=>n.text).join(""):e.content||JSON.stringify(e);case v:if(e.candidates&&e.candidates.length>0){let n=e.candidates[0];if(n.content&&n.content.parts&&n.content.parts.length>0)return n.content.parts.filter(o=>o.text).map(o=>o.text).join("")}return e.text||JSON.stringify(e);case g:return e.message&&e.message.content?e.message.content:e.response?e.response:JSON.stringify(e);default:let i=this.handleChoicesWithFinishReason(e==null?void 0:e.choices);return i!==null?i:(e==null?void 0:e.response)||JSON.stringify(e)}}processStreamLine(e,t,r){switch(r){case d:case u:case f:return this.processOpenAIFormat(e,t);case S:return this.processAnthropicFormat(e,t);case v:return this.processGeminiFormat(e,t);case g:return this.processOllamaFormat(e,t);default:return t}}processAnthropicFormat(e,t){if(e.trim()==="")return t;try{if(e.startsWith("event: "))return t;if(e.startsWith("data: ")){let r=e.substring(6).trimStart();if(r==="[DONE]")return t;try{let i=JSON.parse(r);if(i.type==="content_block_delta"){if(i.delta&&i.delta.text)return this.addToBuffer(i.delta.text),t+i.delta.text}else if(i.type==="content_block_start"&&i.content_block&&i.content_block.type==="text"&&i.content_block.text)return this.addToBuffer(i.content_block.text),t+i.content_block.text}catch(i){}}return t}catch(r){return t}}processOpenAIFormat(e,t){if(e.trim()==="")return t;try{let r=e.substring(5).trimStart(),i=JSON.parse(r);if(i.citations&&i.citations.length>0)for(let n of i.citations)this.collectedCitations.add(n);if(i.choices&&i.choices.length>0){let n=i.choices.filter(o=>o.finish_reason);if(n.length>0){let o=n.filter(l=>l.finish_reason==="stop");if(n.filter(l=>l.finish_reason==="length").length>0){let l;return o.length>0?l=`

`+Le:l=`

`+xe,this.addToBuffer(l),t+l}}if(i.choices[0]){let{delta:o}=i.choices[0];if(o&&o.content)return this.addToBuffer(o.content),t+o.content}}return t}catch(r){return t}}processOllamaFormat(e,t){if(e.trim()==="")return t;try{let r=JSON.parse(e);if(r.message&&r.message.content){let i=r.message.content;return this.addToBuffer(i),t+i}return r.response?(this.addToBuffer(r.response),t+r.response):t}catch(r){return t}}processGeminiFormat(e,t){if(e.trim()==="")return t;try{let r=e.substring(5).trimStart();if(r==="[DONE]")return t;let i=JSON.parse(r);if(i.candidates&&i.candidates.length>0){let n=i.candidates[0];if(n.content&&n.content.parts&&n.content.parts.length>0){let o=n.content.parts.filter(s=>s.text).map(s=>s.text).join("");if(o)return this.addToBuffer(o),t+o}}return t}catch(r){return t}}async processStreamResponse(e,t,r,i,n,o){let s=e.body.getReader(),l=new TextDecoder,c=!1,p="",m=!1;this.startFlushTimer(r,i.newCursor,n);try{for(;!c;){let{value:T,done:k}=await s.read();if(c=k,c)break;let _=l.decode(T).split(`
`);for(let q of _)q.startsWith("data: [DONE]")||(q.startsWith("data:")?p=this.processStreamLine(q,p,t):q.trim()!==""&&(p=this.processStreamLine(q,p,t)))}}catch(T){}finally{this.stopFlushTimer()}if(o&&o.wasAborted())return m=!0,o.resetAbortedFlag(),this.resetBufferState(),n||r.replaceRange("",i.initialCursor,r.getCursor()),{text:"",wasAborted:m};if(this.collectedCitations.size>0){let k=`

**Sources:**
`+Array.from(this.collectedCitations).map((P,_)=>`${_+1}. [${P}](${P})`).join(`
`);if(n)r.replaceSelection(k);else{let P=r.getCursor();r.replaceRange(k,P);let _=r.offsetToPos(r.posToOffset(P)+k.length);r.setCursor(_)}p+=k,this.collectedCitations.clear()}return{text:p,wasAborted:m}}};var I=class{constructor(e){this.notificationService=e}handleApiError(e,t,r={showNotification:!0,logToConsole:!0,returnForChat:!1}){var c,p,m,T;let i=`[ChatGPT MD] ${t}`,n="",o=((c=r.context)==null?void 0:c.model)||"",s=((p=r.context)==null?void 0:p.url)||"",l=this.formatContextInfo(o,s);if(e instanceof Object?e.name==="AbortError"?n=`${i}: Stream aborted`:e.message===st?n=`${i}: Network connection error`:e.status===401||((m=e.error)==null?void 0:m.status)===401?n=`${i}: Authentication failed (401)`:e.status===404||((T=e.error)==null?void 0:T.status)===404?n=`${i}: Resource not found (404)${l?` - ${l}`:""}`:e.error?n=`${i}: ${e.error.message}${l?` - ${l}`:""}`:n=`${i}: ${JSON.stringify(e)}${l?` - ${l}`:""}`:n=`${i}: ${e}${l?` - ${l}`:""}`,r.logToConsole,r.showNotification&&this.notificationService.showNotification(n,5e3),r.returnForChat)return`I am sorry, I could not answer your request because of an error, here is what went wrong-

${e instanceof Object&&e.error?e.error.message:(e==null?void 0:e.message)||e||"undefined"}

Model- ${o}, URL- ${s}`;throw new Error(n)}formatContextInfo(e,t){let r=[];return e&&r.push(`Model: ${e}`),t&&r.push(`URL: ${t}`),r.length>0?r.join(", "):""}handleUrlError(e,t,r){let i=`[ChatGPT MD] Error calling specified URL: ${e}`;return this.notificationService.showNotification(i),`I am sorry, I could not answer your request because of an error, here is what went wrong-

Error connecting to the custom URL.

Model- ${r===g?"llama2":"unknown"}, URL- ${e}`}handleModelError(e,t){let r=`[ChatGPT MD] Error calling model: ${e}`;return this.notificationService.showNotification(r),`I am sorry, there was an error with the model: ${e}. Please check your settings or try a different model.`}handleValidationError(e,t){let r=`[ChatGPT MD] Validation Error: ${e}`;throw this.notificationService.showNotification(r),new Error(r)}};var me,ue,ke;(async()=>{try{let a=await import("http"),e=await import("https"),t=await import("url");me=a.request,ue=e.request,ke=t.URL}catch(a){me=null,ue=null,ke=globalThis.URL}})();async function ut(a){return me&&ue?Ft(a):bt(a)}async function Ft(a){return new Promise((e,t)=>{let r=new ke(a.url),i=r.protocol==="https:",n=i?ue:me,o={hostname:r.hostname==="localhost"?"127.0.0.1":r.hostname,port:r.port||(i?443:80),path:r.pathname+r.search,method:a.method||"GET",headers:{"Content-Type":"application/json",...a.headers}},s=n(o,l=>{let c=new Headers;Object.entries(l.headers).forEach(([P,_])=>{_&&c.set(P,Array.isArray(_)?_.join(", "):String(_))});let p=l.statusCode||0,m=p>=200&&p<300,T=new ReadableStream({start(P){l.on("data",_=>{P.enqueue(new Uint8Array(_))}),l.on("end",()=>{P.close()}),l.on("error",_=>{P.error(_)})}}),k={ok:m,status:p,statusText:l.statusMessage||"",headers:c,body:T,json:async()=>{let P=T.getReader(),_=[];try{for(;;){let{done:$,value:Re}=await P.read();if($)break;_.push(Re)}let q=_.reduce(($,Re)=>$+Re.length,0),ee=new Uint8Array(q),te=0;for(let $ of _)ee.set($,te),te+=$.length;let j=new TextDecoder().decode(ee);return JSON.parse(j)}finally{P.releaseLock()}},text:async()=>{let P=T.getReader(),_=[];try{for(;;){let{done:j,value:$}=await P.read();if(j)break;_.push($)}let q=_.reduce((j,$)=>j+$.length,0),ee=new Uint8Array(q),te=0;for(let j of _)ee.set(j,te),te+=j.length;return new TextDecoder().decode(ee)}finally{P.releaseLock()}},clone:()=>{throw new Error("Response cloning not implemented for requestStream")}};e(k)});a.signal&&a.signal.addEventListener("abort",()=>{s.destroy(),t(new Error("Request aborted"))}),s.on("error",l=>{t(l)}),a.body&&s.write(a.body),s.end()})}async function bt(a){let e={method:a.method||"GET",headers:{"Content-Type":"application/json",...a.headers},signal:a.signal};return a.body&&(e.body=a.body),await fetch(a.url,e)}var R=class{constructor(e,t,r,i){this.abortController=null;this.wasStreamingAborted=!1;this.notificationService=t||new F,this.errorService=e||new I(this.notificationService),this.apiAuthService=r||new y,this.apiResponseParser=i||new O}async makeStreamingRequest(e,t,r,i){try{this.abortController=new AbortController;let n=await ut({url:e,method:"POST",headers:r,body:JSON.stringify(t),signal:this.abortController.signal});if(!n.ok)throw await this.handleHttpError(n,i,t,e);if(!n.body)throw new Error("The response body was empty");return n}catch(n){return this.handleRequestError(n,i,t,e)}}async makeNonStreamingRequest(e,t,r,i){try{let o=(await(0,Ue.requestUrl)({url:e,method:"POST",headers:r,contentType:"application/json",body:JSON.stringify(t),throw:!1})).json;return o!=null&&o.error?this.errorService.handleApiError({error:o.error},i,{returnForChat:!0,showNotification:!0,context:{model:t.model,url:e}}):this.apiResponseParser.parseNonStreamingResponse(o,i)}catch(n){return this.errorService.handleApiError(n,i,{returnForChat:!0,showNotification:!0,context:{model:t.model,url:e}})}}async makeGetRequest(e,t,r){try{let i=await(0,Ue.requestUrl)({url:e,method:"GET",headers:t,throw:!1});if(i.status!==200)throw new Error(`Failed to fetch data from ${e}: ${i.status}`);return i.json}catch(i){throw i}}async handleHttpError(e,t,r,i){let n;try{n=await e.json()}catch(s){n={status:e.status,statusText:e.statusText}}let o=this.errorService.handleApiError(n,t,{returnForChat:!1,showNotification:!0,context:{model:r.model,url:i,status:e.status}});return new Error(o)}handleRequestError(e,t,r,i){return this.errorService.handleApiError(e,t,{returnForChat:!1,showNotification:!0,context:{model:r.model,url:i}})}stopStreaming(){this.abortController&&(this.wasStreamingAborted=!0,this.abortController.abort(),this.abortController=null)}wasAborted(){return this.wasStreamingAborted}resetAbortedFlag(){this.wasStreamingAborted=!1}};var L=class{constructor(e,t){this.inferTitleFromMessages=async(e,t,r)=>{try{if(t.length<2)return this.notificationService.showWarning("Not enough messages to infer title. Minimum 2 messages."),"";let i=`Infer title from the summary of the content of these messages. The title **cannot** contain any of the following characters: colon (:), back slash (\\), forward slash (/), asterisk (*), question mark (?), double quote ("), less than (<), greater than (>), or pipe (|) as these are invalid in file names. Just return the title. Write the title in ${r.inferTitleLanguage}. 
Messages:${D}${JSON.stringify(t)}`,n=this.getDefaultConfig(),o={...n,...r};o.model||(o.model=n.model),o.url||(o.url=n.url);try{return await this.callNonStreamingAPIForTitleInference(e,[{role:N,content:i}],o,r)}catch(s){return""}}catch(i){return this.showNoTitleInferredNotification(),""}};this.notificationService=t!=null?t:new F,this.errorService=e!=null?e:new I(this.notificationService),this.apiService=new R(this.errorService,this.notificationService),this.apiAuthService=new y(this.notificationService),this.apiResponseParser=new O(this.notificationService)}handleTitleTruncationError(e,t){let r=e.editor,i=r.lastLine(),n=r.getLine(i).length,o={line:i,ch:n};r.setCursor(o);let l=`
---
${"#".repeat(2)+" "}${lt}
`;r.replaceRange(l+t+`
`,o)}isTruncationError(e){return e.includes(at)}async callAIAPI(e,t={},r,i,n,o,s,l){let c={...this.getDefaultConfig(),...t};return l&&(c.url=i),t.stream&&n?this.callStreamingAPI(s,e,c,n,r,o,l):this.callNonStreamingAPI(s,e,c,l)}async inferTitle(e,t,r,i){try{if(!e.file)throw new Error("No active file found");let n=this.getApiKeyFromSettings(t),o=await this.inferTitleFromMessages(n,r,t),s="";if(typeof o=="string"){if(this.isTruncationError(o))return this.handleTitleTruncationError(e,o),this.showNoTitleInferredNotification(),"";s=o}else if(o&&typeof o=="object"){let c=o.fullString||"";if(this.isTruncationError(c))return this.handleTitleTruncationError(e,c),this.showNoTitleInferredNotification(),"";s=c}return s&&s.trim().length>0?(await i.writeInferredTitle(e,s.trim()),s.trim()):(this.showNoTitleInferredNotification(),"")}catch(n){return this.showNoTitleInferredNotification(),""}}showNoTitleInferredNotification(){var e;(e=this.notificationService)==null||e.showWarning("Could not infer title. The file name was not changed.")}async callNonStreamingAPIForTitleInference(e,t,r,i){try{r.stream=!1;let{payload:n,headers:o}=this.prepareApiCall(e,t,r,i,!0);return await this.apiService.makeNonStreamingRequest(this.getApiEndpoint(r),n,o,this.serviceType)}catch(n){throw n}}stopStreaming(){var e;(e=this.apiService)==null||e.stopStreaming()}processStreamingResult(e){return e.wasAborted&&e.text===""?{fullString:"",mode:"streaming",wasAborted:!0}:{fullString:e.text,mode:"streaming",wasAborted:e.wasAborted}}getApiEndpoint(e){return`${e.url}${He[this.serviceType]}`}addPluginSystemMessage(e,t){return this.supportsSystemField()?e:[{role:this.getSystemMessageRole(),content:t.pluginSystemMessage},...e]}processSystemCommands(e,t){return!t||t.length===0||this.supportsSystemField()?e:[...t.map(i=>({role:this.getSystemMessageRole(),content:i})),...e]}prepareApiCall(e,t,r,i,n=!1){this.apiAuthService.validateApiKey(e,this.serviceType);let o=n?t:this.addPluginSystemMessage(t,i),s=this.createPayload(r,o),l=this.apiAuthService.createAuthHeaders(e,this.serviceType);return this.supportsSystemField()&&!n&&!s.system&&(s.system=i.pluginSystemMessage),{payload:s,headers:l}}handleApiCallError(e,t,r=!1){if(!!r)throw e;return this.errorService.handleApiError(e,this.serviceType,{returnForChat:!0,showNotification:!0,context:{model:t.model,url:t.url}})}async defaultCallStreamingAPI(e,t,r,i,n,o,s){try{let{payload:l,headers:c}=this.prepareApiCall(e,t,r,s),p=this.apiResponseParser.insertAssistantHeader(i,n,l.model),m=await this.apiService.makeStreamingRequest(this.getApiEndpoint(r),l,c,this.serviceType),T=await this.apiResponseParser.processStreamResponse(m,this.serviceType,i,p,o,this.apiService);return this.processStreamingResult(T)}catch(l){return{fullString:`Error: ${l}`,mode:"streaming"}}}async defaultCallNonStreamingAPI(e,t,r,i){var n;try{r.stream=!1;let{payload:o,headers:s}=this.prepareApiCall(e,t,r,i);return{fullString:await this.apiService.makeNonStreamingRequest(this.getApiEndpoint(r),o,s,this.serviceType),model:o.model}}catch(o){let s=t.length===1&&((n=t[0].content)==null?void 0:n.toString().includes("Infer title from the summary"));return this.handleApiCallError(o,r,s)}}},dt=(a,e)=>{if(e!=null&&e.startsWith("openai@"))return d;if(e!=null&&e.includes(u))return u;if(e!=null&&e.startsWith("lmstudio@"))return f;if(e!=null&&e.startsWith("anthropic@"))return S;if(e!=null&&e.startsWith("gemini@"))return v;if(e!=null&&e.startsWith("ollama@"))return g;if(e!=null&&e.startsWith("local@"))return g;if(e!=null&&e.includes("claude"))return S;if(e!=null&&e.includes("gemini"))return v;if(e!=null&&e.includes("local"))return a!=null&&a.includes("1234")?f:g;if(e!=null&&e.includes("gpt")||e!=null&&e.includes("o1")||e!=null&&e.includes("o3")||e!=null&&e.includes("o4"))return d;let t="openrouter",r="anthropic",i="generativelanguage.googleapis.com",n=["localhost","127.0.0.1"],o="1234";if(a!=null&&a.includes(t))return u;if(a!=null&&a.includes(r))return S;if(a!=null&&a.includes(i))return v;if(a!=null&&a.includes(o))return f;if(n.some(s=>a==null?void 0:a.includes(s)))return g;if(e&&!a)return d},ht=a=>{let e=w(a.openrouterApiKey),t=w(a.apiKey),r=w(a.anthropicApiKey),i=w(a.geminiApiKey);return t?d:r?S:i?v:e?u:null};var h={aiService:d,frequency_penalty:0,max_tokens:400,model:"openai@gpt-4.1-mini",presence_penalty:0,stream:!0,system_commands:null,tags:[],temperature:.7,title:"Untitled",top_p:1,url:"https://api.openai.com"},gt=async(a,e)=>{try{let t=new y;if(!w(e))return[];let r=new R,i=t.createAuthHeaders(e,d);return(await r.makeGetRequest(`${a}/v1/models`,i,d)).data.filter(o=>(o.id.includes("o3")||o.id.includes("o4")||o.id.includes("o1")||o.id.includes("gpt-4")||o.id.includes("gpt-5")||o.id.includes("gpt-3"))&&!o.id.includes("audio")&&!o.id.includes("transcribe")&&!o.id.includes("realtime")&&!o.id.includes("o1-pro")&&!o.id.includes("tts")).sort((o,s)=>o.id<s.id?1:o.id>s.id?-1:0).map(o=>`openai@${o.id}`)}catch(t){return[]}},de=class extends L{constructor(t,r,i,n,o){super(t,r);this.serviceType=d;this.errorService=t||new I(this.notificationService),this.apiService=i||new R(this.errorService,this.notificationService),this.apiAuthService=n||new y(this.notificationService),this.apiResponseParser=o||new O(this.notificationService)}getDefaultConfig(){return h}getApiKeyFromSettings(t){return this.apiAuthService.getApiKey(t,d)}getSystemMessageRole(){return be}supportsSystemField(){return!1}createPayload(t,r){let i=t.model.includes("@")?t.model.split("@")[1]:t.model,n=this.processSystemCommands(r,t.system_commands),o={model:i,messages:n,max_completion_tokens:t.max_tokens,stream:t.stream};return i.includes("search")||i.includes("o1")||i.includes("o4")||i.includes("o3")||i.includes("gpt-5")||(o.temperature=t.temperature,o.top_p=t.top_p,o.presence_penalty=t.presence_penalty,o.frequency_penalty=t.frequency_penalty),o}handleAPIError(t,r,i){let n={model:r.model,url:r.url,defaultUrl:h.url,aiService:d};return t instanceof Object&&r.url!==h.url?this.errorService.handleUrlError(r.url,h.url,d):this.errorService.handleApiError(t,d,{context:n,showNotification:!0,logToConsole:!0})}async callStreamingAPI(t,r,i,n,o,s,l){return this.defaultCallStreamingAPI(t,r,i,n,o,s,l)}async callNonStreamingAPI(t,r,i,n){return this.defaultCallNonStreamingAPI(t,r,i,n)}showNoTitleInferredNotification(){this.notificationService.showWarning("Could not infer title. The file name was not changed.")}};var b={aiService:g,model:"",url:"http://localhost:11434",stream:!0,title:"Untitled",system_commands:null},ft=async a=>{try{let e=new R,t={"Content-Type":"application/json"};return(await e.makeGetRequest(`${a}/api/tags`,t,g)).models.sort((n,o)=>n.name<o.name?1:n.name>o.name?-1:0).map(n=>`ollama@${n.name}`)}catch(e){return[]}},he=class extends L{constructor(t,r,i,n,o){super(t,r);this.serviceType=g;this.errorService=t||new I(this.notificationService),this.apiService=i||new R(this.errorService,this.notificationService),this.apiAuthService=n||new y(this.notificationService),this.apiResponseParser=o||new O(this.notificationService)}getDefaultConfig(){return b}getApiKeyFromSettings(t){return this.apiAuthService.getApiKey(t,g)}getSystemMessageRole(){return U}supportsSystemField(){return!1}createPayload(t,r){let i=t.model.includes("@")?t.model.split("@")[1]:t.model,n=this.processSystemCommands(r,t.system_commands);return{model:i,messages:n,stream:t.stream}}handleAPIError(t,r,i){let n={model:r.model,url:r.url,defaultUrl:b.url,aiService:g};return t instanceof Object&&r.url!==b.url?this.errorService.handleUrlError(r.url,b.url,g):this.errorService.handleApiError(t,g,{context:n,showNotification:!0,logToConsole:!0})}async callStreamingAPI(t,r,i,n,o,s,l){return this.defaultCallStreamingAPI(t,r,i,n,o,s,l)}async callNonStreamingAPI(t,r,i,n){return this.defaultCallNonStreamingAPI(t,r,i,n)}showNoTitleInferredNotification(){this.notificationService.showWarning("Could not infer title. The file name was not changed.")}};var A={aiService:u,frequency_penalty:.5,max_tokens:400,model:"openrouter@openai/gpt-4.1-mini",openrouterApiKey:"",presence_penalty:.5,stream:!0,system_commands:null,tags:[],temperature:.7,title:"Untitled",top_p:1,url:"https://openrouter.ai"},St=async(a,e)=>{try{let t=new y;if(!w(e))return[];let r=new R,i=t.createAuthHeaders(e,u);return(await r.makeGetRequest(`${a}/api/v1/models`,i,u)).data.sort((o,s)=>o.id<s.id?1:o.id>s.id?-1:0).map(o=>`${u}@${o.id}`)}catch(t){return[]}},ge=class extends L{constructor(t,r,i,n,o){super(t,r);this.serviceType=u;this.errorService=t||new I(this.notificationService),this.apiService=i||new R(this.errorService,this.notificationService),this.apiAuthService=n||new y(this.notificationService),this.apiResponseParser=o||new O(this.notificationService)}getDefaultConfig(){return A}getApiKeyFromSettings(t){return this.apiAuthService.getApiKey(t,u)}getSystemMessageRole(){return U}supportsSystemField(){return!1}createPayload(t,r){let i=t.model.includes("@")?t.model.split("@")[1]:t.model,n=this.processSystemCommands(r,t.system_commands);return{model:i,messages:n,max_tokens:t.max_tokens,temperature:t.temperature,top_p:t.top_p,presence_penalty:t.presence_penalty,frequency_penalty:t.frequency_penalty,stream:t.stream}}handleAPIError(t,r,i){let n={model:r.model,url:r.url,defaultUrl:A.url,aiService:u};return t instanceof Object&&r.url!==A.url?this.errorService.handleUrlError(r.url,A.url,u):this.errorService.handleApiError(t,u,{context:n,showNotification:!0,logToConsole:!0})}async callStreamingAPI(t,r,i,n,o,s,l){return this.defaultCallStreamingAPI(t,r,i,n,o,s,l)}async callNonStreamingAPI(t,r,i,n){return this.defaultCallNonStreamingAPI(t,r,i,n)}showNoTitleInferredNotification(){this.notificationService.showWarning("Could not infer title. The file name was not changed.")}};var C={aiService:f,frequency_penalty:0,max_tokens:400,model:"",presence_penalty:0,stream:!0,system_commands:null,tags:[],temperature:.7,title:"Untitled",top_p:1,url:"http://localhost:1234"},vt=async(a,e)=>{try{let t=new y,r=e&&w(e)?t.createAuthHeaders(e,f):{"Content-Type":"application/json"};return(await new R().makeGetRequest(`${a}/v1/models`,r,f)).data.filter(o=>!o.id.includes("embedding")&&!o.id.includes("audio")&&!o.id.includes("transcribe")&&!o.id.includes("tts")).sort((o,s)=>o.id<s.id?1:o.id>s.id?-1:0).map(o=>`lmstudio@${o.id}`)}catch(t){return[]}},fe=class extends L{constructor(t,r,i,n,o){super(t,r);this.serviceType=f;this.errorService=t||new I(this.notificationService),this.apiService=i||new R(this.errorService,this.notificationService),this.apiAuthService=n||new y(this.notificationService),this.apiResponseParser=o||new O(this.notificationService)}getDefaultConfig(){return C}getApiKeyFromSettings(t){return this.apiAuthService.getApiKey(t,f)}getSystemMessageRole(){return U}supportsSystemField(){return!1}createPayload(t,r){let i=t.model.includes("@")?t.model.split("@")[1]:t.model,n=this.processSystemCommands(r,t.system_commands);return{model:i,messages:n,max_completion_tokens:t.max_tokens,stream:t.stream,temperature:t.temperature,top_p:t.top_p,presence_penalty:t.presence_penalty,frequency_penalty:t.frequency_penalty}}handleAPIError(t,r,i){let n={model:r.model,url:r.url,defaultUrl:C.url,aiService:f};return t instanceof Object&&r.url!==C.url?this.errorService.handleUrlError(r.url,C.url,f):this.errorService.handleApiError(t,f,{context:n,showNotification:!0,logToConsole:!0})}async callStreamingAPI(t,r,i,n,o,s,l){return this.defaultCallStreamingAPI(t,r,i,n,o,s,l)}async callNonStreamingAPI(t,r,i,n){return this.defaultCallNonStreamingAPI(t,r,i,n)}showNoTitleInferredNotification(){this.notificationService.showWarning("Could not infer title. The file name was not changed.")}};var At=require("obsidian");var M={aiService:S,max_tokens:400,model:"anthropic@claude-sonnet-4-20250514",stream:!0,system_commands:null,tags:[],temperature:.7,title:"Untitled",url:"https://api.anthropic.com"},yt=async(a,e)=>{try{if(!w(e))return[];let t=`${a.replace(/\/$/,"")}/v1/models`,i=(await(0,At.requestUrl)({url:t,method:"GET",headers:{"x-api-key":e,"anthropic-version":"2023-06-01","anthropic-dangerous-direct-browser-access":"true","Content-Type":"application/json"}})).json;return i.data&&Array.isArray(i.data)?i.data.filter(n=>n.type==="model"&&n.id).map(n=>`anthropic@${n.id}`).sort():[]}catch(t){return[]}},Se=class extends L{constructor(t,r,i,n,o){super(t,r);this.serviceType=S;this.errorService=t||new I(this.notificationService),this.apiService=i||new R(this.errorService,this.notificationService),this.apiAuthService=n||new y(this.notificationService),this.apiResponseParser=o||new O(this.notificationService)}getDefaultConfig(){return M}getApiKeyFromSettings(t){return this.apiAuthService.getApiKey(t,S)}getSystemMessageRole(){return U}supportsSystemField(){return!0}createPayload(t,r){let i=t.model.includes("@")?t.model.split("@")[1]:t.model,n=this.convertToAnthropicMessages(r),o={model:i,messages:n,max_tokens:t.max_tokens,stream:t.stream};return t.temperature!==void 0&&(o.temperature=t.temperature),o}convertToAnthropicMessages(t){let r=[];for(let i of t){if(i.role===U)continue;let n;i.role===x?n="assistant":n="user",r.push({role:n,content:i.content})}return r}handleAPIError(t,r,i){let n={model:r.model,url:r.url,defaultUrl:M.url,aiService:S};return t instanceof Object&&r.url!==M.url?this.errorService.handleUrlError(r.url,M.url,S):this.errorService.handleApiError(t,S,{context:n,showNotification:!0,logToConsole:!0})}async callStreamingAPI(t,r,i,n,o,s,l){return this.defaultCallStreamingAPI(t,r,i,n,o,s,l)}async callNonStreamingAPI(t,r,i,n){return this.defaultCallNonStreamingAPI(t,r,i,n)}showNoTitleInferredNotification(){this.notificationService.showWarning("Could not infer title. The file name was not changed.")}prepareApiCall(t,r,i,n,o=!1){this.apiAuthService.validateApiKey(t,this.serviceType);let s=o?r:this.addPluginSystemMessage(r,n),l=i,c=this.createPayload(l,s),p=this.apiAuthService.createAuthHeaders(t,this.serviceType);if(o)l.system_commands&&l.system_commands.length>0&&(c.system=l.system_commands.join(`

`));else{let m=[];m.push(n.pluginSystemMessage),l.system_commands&&l.system_commands.length>0&&m.push(l.system_commands.join(`

`)),c.system=m.join(`

`)}return p["anthropic-dangerous-direct-browser-access"]="true",{payload:c,headers:p}}};var Et=require("obsidian");var E={aiService:v,max_tokens:400,model:"gemini@gemini-2.5-flash",stream:!0,system_commands:null,tags:[],temperature:.7,title:"Untitled",top_p:.95,url:"https://generativelanguage.googleapis.com"},Tt=async(a,e)=>{try{if(!w(e))return[];let t=`${a.replace(/\/$/,"")}/v1beta/models`,i=(await(0,Et.requestUrl)({url:t,method:"GET",headers:{"x-goog-api-key":e,"Content-Type":"application/json"}})).json;return i.models&&Array.isArray(i.models)?i.models.filter(n=>n.name&&n.supportedGenerationMethods&&n.supportedGenerationMethods.includes("generateContent")&&!n.name.includes("embedding")).map(n=>`gemini@${n.name.replace("models/","")}`).sort():[]}catch(t){return[]}},ve=class extends L{constructor(t,r,i,n,o){super(t,r);this.serviceType=v;this.errorService=t||new I(this.notificationService),this.apiService=i||new R(this.errorService,this.notificationService),this.apiAuthService=n||new y(this.notificationService),this.apiResponseParser=o||new O(this.notificationService)}getDefaultConfig(){return E}getApiKeyFromSettings(t){return this.apiAuthService.getApiKey(t,v)}getSystemMessageRole(){return U}supportsSystemField(){return!1}createPayload(t,r){return{contents:this.convertToGeminiContents(r),generationConfig:{maxOutputTokens:t.max_tokens,temperature:t.temperature,topP:t.top_p}}}convertToGeminiContents(t){let r=[];for(let i of t){let n;i.role===x?n="model":n="user",r.push({role:n,parts:[{text:i.content}]})}return r}handleAPIError(t,r,i){let n={model:r.model,url:r.url,defaultUrl:E.url,aiService:v};return t instanceof Object&&r.url!==E.url?this.errorService.handleUrlError(r.url,E.url,v):this.errorService.handleApiError(t,v,{context:n,showNotification:!0,logToConsole:!0})}async callStreamingAPI(t,r,i,n,o,s,l){try{let{payload:c,headers:p}=this.prepareApiCall(t,r,i,l),m=this.apiResponseParser.insertAssistantHeader(n,o,i.model),T=await this.apiService.makeStreamingRequest(this.getApiUrl(i),c,p,this.serviceType),k=await this.apiResponseParser.processStreamResponse(T,this.serviceType,n,m,s,this.apiService);return this.processStreamingResult(k)}catch(c){return{fullString:`Error: ${c}`,mode:"streaming"}}}async callNonStreamingAPI(t,r,i,n){var o;try{i.stream=!1;let{payload:s,headers:l}=this.prepareApiCall(t,r,i,n);return{fullString:await this.apiService.makeNonStreamingRequest(this.getApiUrl(i),s,l,this.serviceType),model:i.model}}catch(s){let l=r.length===1&&((o=r[0].content)==null?void 0:o.toString().includes("Infer title from the summary"));return this.handleApiCallError(s,i,l)}}showNoTitleInferredNotification(){this.notificationService.showWarning("Could not infer title. The file name was not changed.")}async callNonStreamingAPIForTitleInference(t,r,i,n){try{i.stream=!1;let{payload:o,headers:s}=this.prepareApiCall(t,r,i,n,!0);return await this.apiService.makeNonStreamingRequest(this.getApiUrl(i),o,s,this.serviceType)}catch(o){throw o}}prepareApiCall(t,r,i,n,o=!1){this.apiAuthService.validateApiKey(t,this.serviceType);let s=o?r:this.addPluginSystemMessage(r,n),l=i,c=this.createPayload(l,s),p=this.apiAuthService.createAuthHeaders(t,this.serviceType);return p["x-goog-api-key"]=t,{payload:c,headers:p}}getApiUrl(t){let r=t,i=r.model.includes("@")?r.model.split("@")[1]:r.model;return r.stream?`${r.url}/v1beta/models/${i}:streamGenerateContent?alt=sse`:`${r.url}/v1beta/models/${i}:generateContent`}};var Ae=class{constructor(e,t){this.app=e;this.frontmatterManager=t}async getFrontmatter(e,t){let r={};if(e.file){let c=await this.frontmatterManager.readFrontmatter(e.file);c&&(r={...c})}let i=t.defaultChatFrontmatter?Ge(t.defaultChatFrontmatter):{},n={...i,...t,...r},o=n.aiService||dt(n.url,n.model)||ht(n)||d;return{...{[d]:h,[g]:b,[u]:A,[f]:C,[S]:M,[v]:E}[o]||h,...i,...t,...r,aiService:o}}async updateFrontmatterField(e,t,r){let i=this.app.workspace.getActiveViewOfType(Ct.MarkdownView);if(!i||!i.file)return;let n=i.file;try{await this.frontmatterManager.updateFrontmatterField(n,t,r)}catch(o){throw o}}objectToYamlFrontmatter(e){return`---
${Object.entries(e).map(([r,i])=>i==null?`${r}:`:typeof i=="string"?`${r}: "${i}"`:`${r}: ${i}`).join(`
`)}
---

`}generateFrontmatter(e,t={}){if(e.defaultChatFrontmatter){if(Object.keys(t).length>0){let o={...Ge(e.defaultChatFrontmatter),...t};return this.objectToYamlFrontmatter(o)}return e.defaultChatFrontmatter+`

`}let r=t.aiService||d,i={stream:e.stream,...t};switch(r){case d:i={...i,model:e.openaiDefaultModel,temperature:e.openaiDefaultTemperature,top_p:e.openaiDefaultTopP,max_tokens:e.openaiDefaultMaxTokens,presence_penalty:e.openaiDefaultPresencePenalty,frequency_penalty:e.openaiDefaultFrequencyPenalty};break;case g:i={...i,url:e.ollamaUrl,temperature:e.ollamaDefaultTemperature,top_p:e.ollamaDefaultTopP};break;case u:i={...i,model:e.openrouterDefaultModel,temperature:e.openrouterDefaultTemperature,top_p:e.openrouterDefaultTopP,max_tokens:e.openrouterDefaultMaxTokens,presence_penalty:e.openrouterDefaultPresencePenalty,frequency_penalty:e.openrouterDefaultFrequencyPenalty};break;case f:i={...i,url:e.lmstudioUrl,temperature:e.lmstudioDefaultTemperature,top_p:e.lmstudioDefaultTopP,presence_penalty:e.lmstudioDefaultPresencePenalty,frequency_penalty:e.lmstudioDefaultFrequencyPenalty};break;case S:i={...i,model:e.anthropicDefaultModel,url:e.anthropicUrl,temperature:e.anthropicDefaultTemperature,max_tokens:e.anthropicDefaultMaxTokens};break;case v:i={...i,model:e.geminiDefaultModel,url:e.geminiUrl,temperature:e.geminiDefaultTemperature,top_p:e.geminiDefaultTopP,max_tokens:e.geminiDefaultMaxTokens};break}return this.objectToYamlFrontmatter(i)}};var ye=class{constructor(e,t,r,i,n,o){this.app=e;this.fileService=t||new z(e),this.editorContentService=r||new X(e);let s=new F;if(this.messageService=i||new Z(this.fileService,s),!o)throw new Error("FrontmatterService must be provided as it requires FrontmatterManager dependency");this.frontmatterService=o,this.templateService=n||new Q(e,this.fileService,this.editorContentService)}async writeInferredTitle(e,t){return this.fileService.writeInferredTitle(e,t)}async ensureFolderExists(e,t){return this.fileService.ensureFolderExists(e,t)}getDate(e,t){return this.fileService.formatDate(e,t)}addHorizontalRule(e,t,r){this.editorContentService.addHorizontalRule(e,t,r)}async clearChat(e){await this.editorContentService.clearChat(e)}moveCursorToEnd(e){this.editorContentService.moveCursorToEnd(e)}async getMessagesFromEditor(e,t){return this.messageService.getMessagesFromEditor(e,t)}async createNewChatFromTemplate(e,t){return this.templateService.createNewChatFromTemplate(e,t)}async createNewChatWithHighlightedText(e,t){return this.templateService.createNewChatWithHighlightedText(e,t)}async getFrontmatter(e,t,r){return await this.frontmatterService.getFrontmatter(e,t)}processResponse(e,t,r){this.messageService.processResponse(e,t,r)}async setModel(e,t){await this.frontmatterService.updateFrontmatterField(e,"model",t)}};var xt=()=>`---
system_commands: ['You are a helpful assistant.']
frequency_penalty: ${h.frequency_penalty}
max_tokens: ${h.max_tokens}
model: ${h.model}
presence_penalty: ${h.presence_penalty}
stream: true
temperature: ${h.temperature}
---`,$e={apiKey:"",openrouterApiKey:"",anthropicApiKey:"",geminiApiKey:"",openaiUrl:h.url,openrouterUrl:A.url,ollamaUrl:b.url,lmstudioUrl:C.url,anthropicUrl:M.url,geminiUrl:E.url,chatFolder:"ChatGPT_MD/chats",chatTemplateFolder:"ChatGPT_MD/templates",stream:!0,generateAtCursor:!1,autoInferTitle:!1,pluginSystemMessage:ce,dateFormat:le,headingLevel:it,inferTitleLanguage:nt,defaultChatFrontmatter:xt(),openaiDefaultModel:h.model,openaiDefaultTemperature:h.temperature,openaiDefaultTopP:h.top_p,openaiDefaultMaxTokens:h.max_tokens,openaiDefaultPresencePenalty:h.presence_penalty,openaiDefaultFrequencyPenalty:h.frequency_penalty,anthropicDefaultModel:M.model,anthropicDefaultTemperature:M.temperature,anthropicDefaultMaxTokens:M.max_tokens,geminiDefaultModel:E.model,geminiDefaultTemperature:E.temperature,geminiDefaultTopP:E.top_p,geminiDefaultMaxTokens:E.max_tokens,openrouterDefaultModel:A.model,openrouterDefaultTemperature:A.temperature,openrouterDefaultTopP:A.top_p,openrouterDefaultMaxTokens:A.max_tokens,openrouterDefaultPresencePenalty:A.presence_penalty,openrouterDefaultFrequencyPenalty:A.frequency_penalty,ollamaDefaultTemperature:.7,ollamaDefaultTopP:1,lmstudioDefaultTemperature:C.temperature,lmstudioDefaultTopP:C.top_p,lmstudioDefaultPresencePenalty:C.presence_penalty,lmstudioDefaultFrequencyPenalty:C.frequency_penalty};var Te=require("obsidian");var Ee=class extends Te.PluginSettingTab{constructor(e,t,r){super(e,t),this.settingsProvider=r}display(){let{containerEl:e}=this;e.empty();let t=[{id:"apiKey",name:"OpenAI API Key",description:"API Key for OpenAI",type:"text",placeholder:"your openAI API Key",group:"API Keys"},{id:"openrouterApiKey",name:"OpenRouter.ai API Key",description:"API Key for OpenRouter.ai",type:"text",placeholder:"your openRouter API Key",group:"API Keys"},{id:"anthropicApiKey",name:"Anthropic API Key",description:"API Key for Anthropic (Claude)",type:"text",placeholder:"your Anthropic API Key",group:"API Keys"},{id:"geminiApiKey",name:"Gemini API Key",description:"API Key for Google Gemini (Google AI Studio)",type:"text",placeholder:"your Gemini API Key",group:"API Keys"},{id:"defaultChatFrontmatter",name:"Default Chat Frontmatter",description:"Default frontmatter for new chat files. You can change/use all of the settings exposed by the OpenAI API here: https://platform.openai.com/docs/api-reference/chat/create",type:"textarea",placeholder:this.settingsProvider.settings.defaultChatFrontmatter,group:"Chat Behavior"},{id:"pluginSystemMessage",name:"Plugin System Message",description:"System message that provides context about the Obsidian/ChatGPT MD plugin environment. This helps the AI understand it's working within Obsidian and format responses appropriately.",type:"textarea",group:"Chat Behavior"},{id:"stream",name:"Stream",description:"Stream responses from OpenAI",type:"toggle",group:"Chat Behavior"},{id:"generateAtCursor",name:"Generate at Cursor",description:"Generate text at cursor instead of end of file",type:"toggle",group:"Chat Behavior"},{id:"autoInferTitle",name:"Automatically Infer Title",description:"Automatically infer title after 4 messages have been exchanged",type:"toggle",group:"Chat Behavior"},{id:"inferTitleLanguage",name:"Infer Title Language",description:"Language to use for title inference.",type:"dropdown",options:{English:"English",Japanese:"Japanese",Spanish:"Spanish",French:"French",German:"German",Chinese:"Chinese",Korean:"Korean",Italian:"Italian",Russian:"Russian"},group:"Chat Behavior"},{id:"openaiUrl",name:"OpenAI API URL",description:`URL for OpenAI API
Default URL: ${h.url}`,type:"text",placeholder:h.url,group:"OpenAI Defaults"},{id:"openaiDefaultModel",name:"Default OpenAI Model",description:"Default model for OpenAI chats",type:"text",placeholder:"openai@gpt-4",group:"OpenAI Defaults"},{id:"openaiDefaultTemperature",name:"Default OpenAI Temperature",description:"Default temperature for OpenAI chats (0.0 to 2.0)",type:"text",placeholder:"0.7",group:"OpenAI Defaults"},{id:"openaiDefaultMaxTokens",name:"Default OpenAI Max Tokens",description:"Default max tokens for OpenAI chats",type:"text",placeholder:"400",group:"OpenAI Defaults"},{id:"anthropicUrl",name:"Anthropic API URL",description:`URL for Anthropic API
Default URL: ${M.url}`,type:"text",placeholder:M.url,group:"Anthropic Defaults"},{id:"anthropicDefaultModel",name:"Default Anthropic Model",description:"Default model for Anthropic chats",type:"text",placeholder:"anthropic@claude-3-5-sonnet-20241022",group:"Anthropic Defaults"},{id:"anthropicDefaultTemperature",name:"Default Anthropic Temperature",description:"Default temperature for Anthropic chats (0.0 to 1.0)",type:"text",placeholder:"0.7",group:"Anthropic Defaults"},{id:"anthropicDefaultMaxTokens",name:"Default Anthropic Max Tokens",description:"Default max tokens for Anthropic chats",type:"text",placeholder:"400",group:"Anthropic Defaults"},{id:"geminiUrl",name:"Gemini API URL",description:`URL for Gemini API
Default URL: ${E.url}`,type:"text",placeholder:E.url,group:"Gemini Defaults"},{id:"geminiDefaultModel",name:"Default Gemini Model",description:"Default model for Gemini chats",type:"text",placeholder:"gemini@gemini-1.5-pro",group:"Gemini Defaults"},{id:"geminiDefaultTemperature",name:"Default Gemini Temperature",description:"Default temperature for Gemini chats (0.0 to 2.0)",type:"text",placeholder:"0.7",group:"Gemini Defaults"},{id:"geminiDefaultMaxTokens",name:"Default Gemini Max Tokens",description:"Default max tokens for Gemini chats",type:"text",placeholder:"400",group:"Gemini Defaults"},{id:"openrouterUrl",name:"OpenRouter.ai API URL",description:`URL for OpenRouter.ai API
Default URL: ${A.url}`,type:"text",placeholder:A.url,group:"OpenRouter Defaults"},{id:"openrouterDefaultModel",name:"Default OpenRouter Model",description:"Default model for OpenRouter chats",type:"text",placeholder:"openrouter@anthropic/claude-3.5-sonnet",group:"OpenRouter Defaults"},{id:"openrouterDefaultTemperature",name:"Default OpenRouter Temperature",description:"Default temperature for OpenRouter chats (0.0 to 2.0)",type:"text",placeholder:"0.7",group:"OpenRouter Defaults"},{id:"openrouterDefaultMaxTokens",name:"Default OpenRouter Max Tokens",description:"Default max tokens for OpenRouter chats",type:"text",placeholder:"400",group:"OpenRouter Defaults"},{id:"ollamaUrl",name:"Ollama API URL",description:`URL for Ollama API
Default URL: ${b.url}`,type:"text",placeholder:b.url,group:"Ollama Defaults"},{id:"ollamaDefaultTemperature",name:"Default Ollama Temperature",description:"Default temperature for Ollama chats (0.0 to 2.0)",type:"text",placeholder:"0.7",group:"Ollama Defaults"},{id:"lmstudioUrl",name:"LM Studio API URL",description:`URL for LM Studio API
Default URL: ${C.url}`,type:"text",placeholder:C.url,group:"LM Studio Defaults"},{id:"lmstudioDefaultTemperature",name:"Default LM Studio Temperature",description:"Default temperature for LM Studio chats (0.0 to 2.0)",type:"text",placeholder:"0.7",group:"LM Studio Defaults"},{id:"chatFolder",name:"Chat Folder",description:"Path to folder for chat files",type:"text",group:"Folders"},{id:"chatTemplateFolder",name:"Chat Template Folder",description:"Path to folder for chat file templates",type:"text",placeholder:"chat-templates",group:"Folders"},{id:"dateFormat",name:"Date Format",description:"Date format for chat files. Valid date blocks are: YYYY, MM, DD, hh, mm, ss",type:"text",placeholder:le,group:"Formatting"},{id:"headingLevel",name:"Heading Level",description:`Heading level for messages (example for heading level 2: '## ${V}${N}'). Valid heading levels are 0, 1, 2, 3, 4, 5, 6`,type:"text",group:"Formatting"}],r={};t.forEach(i=>{r[i.group]||(r[i.group]=[]),r[i.group].push(i)}),Object.entries(r).forEach(([i,n])=>{e.createEl("h3",{text:i}),n.forEach(o=>{this.createSettingElement(e,o)}),e.createEl("hr")})}createSettingElement(e,t){let r=new Te.Setting(e).setName(t.name).setDesc(t.description);t.type==="text"?r.addText(i=>(i.setPlaceholder(t.placeholder||"").setValue(String(this.settingsProvider.settings[t.id])).onChange(async n=>{this.settingsProvider.settings[t.id]=n,await this.settingsProvider.saveSettings()}),i.inputEl.style.width="300px",i)):t.type==="textarea"?r.addTextArea(i=>(i.setPlaceholder(t.placeholder||"").setValue(String(this.settingsProvider.settings[t.id]||t.placeholder)).onChange(async n=>{this.settingsProvider.settings[t.id]=n,await this.settingsProvider.saveSettings()}),i.inputEl.style.width="300px",(t.id==="defaultChatFrontmatter"||t.id==="pluginSystemMessage")&&(i.inputEl.style.height="260px",i.inputEl.style.minHeight="260px"),i)):t.type==="toggle"?r.addToggle(i=>i.setValue(!!this.settingsProvider.settings[t.id]).onChange(async n=>{this.settingsProvider.settings[t.id]=n,await this.settingsProvider.saveSettings()})):t.type==="dropdown"&&t.options&&r.addDropdown(i=>(i.addOptions(t.options||{}),i.setValue(String(this.settingsProvider.settings[t.id])),i.onChange(async n=>{this.settingsProvider.settings[t.id]=n,await this.settingsProvider.saveSettings()}),i.selectEl.style.width="300px",i))}};var Lt=`You are an AI assistant integrated into Obsidian through the ChatGPT MD plugin. You are helping a user who is working within their Obsidian vault - a personal knowledge management system where they store notes, thoughts, and information in Markdown format.

Key context:
- The user is writing in Markdown format within Obsidian
- They may reference other notes in their vault using [[wiki links]] or standard [markdown links](url)
- Your responses will be inserted directly into their Markdown document
- Be concise but helpful, and format your responses appropriately for Markdown
- If you provide code examples, use proper markdown code blocks with language specification
- When suggesting organizational strategies, consider that this is within a personal knowledge management context
- The user may be taking notes, brainstorming, writing, researching, or organizing information

Code block formatting requirements:
- Code blocks must start and end with exactly 3 backticks (\`\`\`) on a new line
- There should be no whitespace before the opening or closing backticks
- The language name should be specified immediately after the opening backticks
- The actual code should start on a new line after the language specification
- Example format:
\`\`\`javascript
console.log("Hello World");
\`\`\`

Inline code formatting requirements:
- Use single backticks (\`) for inline code references like filenames (e.g., \`example.md\`), variable names (e.g., \`myVariable\`), or short code snippets referenced within a paragraph.
- Always ensure that single backticks are properly closed to avoid breaking Markdown rendering. For example, use \`code\` not \`code.

Table formatting requirements:
- Use standard Markdown table syntax.
- Tables should NOT be wrapped in code blocks.

Respond naturally and helpfully while being mindful of this Obsidian/note-taking context.`,Ce=class{async migrateSettings(e,t){let r=!1;return r=await this.migrateUrlSettings(e,t)||r,r=await this.migrateFrontmatterSettings(e,t)||r,r=await this.migratePluginSystemMessage(e,t)||r,r}async migrateUrlSettings(e,t){let r=[{setting:"ollamaUrl",pattern:/\/api\/$/,replacement:"",description:"Removing trailing /api/ from Ollama URL",introducedIn:"2.1.3"},{setting:"openrouterUrl",pattern:/\/api\/$/,replacement:"",description:"Removing trailing /api/ from OpenRouter URL",introducedIn:"2.1.3"},{setting:"openaiUrl",pattern:/\/$/,replacement:"",description:"Removing trailing slash from OpenAI URL",introducedIn:"2.1.3"}],i=!1;for(let n of r){let o=n.setting,s=e[o];s&&n.pattern.test(s)&&(t({[o]:s.replace(n.pattern,n.replacement)}),i=!0)}return i}async migrateFrontmatterSettings(e,t){if(e.hasOwnProperty("openaiDefaultModel")||e.hasOwnProperty("anthropicDefaultModel"))return!1;let i={openaiDefaultModel:h.model,openaiDefaultTemperature:h.temperature,openaiDefaultTopP:h.top_p,openaiDefaultMaxTokens:h.max_tokens,openaiDefaultPresencePenalty:h.presence_penalty,openaiDefaultFrequencyPenalty:h.frequency_penalty,anthropicDefaultModel:M.model,anthropicDefaultTemperature:M.temperature,anthropicDefaultMaxTokens:M.max_tokens,geminiDefaultModel:E.model,geminiDefaultTemperature:E.temperature,geminiDefaultTopP:E.top_p,geminiDefaultMaxTokens:E.max_tokens,openrouterDefaultModel:A.model,openrouterDefaultTemperature:A.temperature,openrouterDefaultTopP:A.top_p,openrouterDefaultMaxTokens:A.max_tokens,openrouterDefaultPresencePenalty:A.presence_penalty,openrouterDefaultFrequencyPenalty:A.frequency_penalty,ollamaDefaultTemperature:.7,ollamaDefaultTopP:1,lmstudioDefaultTemperature:C.temperature,lmstudioDefaultTopP:C.top_p,lmstudioDefaultPresencePenalty:C.presence_penalty,lmstudioDefaultFrequencyPenalty:C.frequency_penalty};return t({...i}),!0}async migratePluginSystemMessage(e,t){var n;let r=(n=e.pluginSystemMessage)==null?void 0:n.trim(),i=Lt.trim();return r!==i?!1:(t({pluginSystemMessage:ce}),!0)}migrateFrontmatterString(e){let t={"model: gpt-4":"model: ${openaiDefaultModel}","model: gpt-4o":"model: ${openaiDefaultModel}","model: claude-3":"model: ${anthropicDefaultModel}","model: gemini-pro":"model: ${geminiDefaultModel}","temperature: 1":"temperature: ${providerDefaultTemperature}","max_tokens: 300":"max_tokens: ${providerDefaultMaxTokens}"},r=e;for(let[i,n]of Object.entries(t))r=r.replace(new RegExp(i,"g"),n);return r!==e&&(r=`# Migrated frontmatter - consider using provider-specific defaults in settings
${r}`),r}};var Me=class{constructor(e,t=new F,r=new I(new F)){this.plugin=e;this.notificationService=t;this.errorService=r;this.migrationService=new Ce,this.settings=structuredClone($e),this.loadSettings().catch(i=>this.notificationService.showError("Failed to load settings"))}getSettings(){return this.settings}async migrateSettings(){await this.migrationService.migrateSettings(this.settings,this.updateSettings.bind(this))&&await this.saveSettings()}migrateFrontmatterString(e){return this.migrationService.migrateFrontmatterString(e)}async loadSettings(){let e=await this.plugin.loadData();return Object.assign(this.settings,$e,e),this.settings}async saveSettings(){await this.plugin.saveData(this.settings)}updateSettings(e){Object.assign(this.settings,e)}async addSettingTab(){await this.loadSettings(),this.plugin.addSettingTab(new Ee(this.plugin.app,this.plugin,{settings:this.settings,saveSettings:this.saveSettings.bind(this)}))}};var Pe=class{constructor(e,t){this.app=e,this.plugin=t,this.initializeServices()}initializeServices(){this.notificationService=new F,this.errorService=new I(this.notificationService),this.apiService=new R(this.errorService,this.notificationService),this.apiAuthService=new y(this.notificationService),this.apiResponseParser=new O(this.notificationService),this.fileService=new z(this.app),this.frontmatterManager=new J(this.app),this.editorContentService=new X(this.app),this.messageService=new Z(this.fileService,this.notificationService),this.frontmatterService=new Ae(this.app,this.frontmatterManager),this.templateService=new Q(this.app,this.fileService,this.editorContentService),this.editorService=new ye(this.app,this.fileService,this.editorContentService,this.messageService,this.templateService,this.frontmatterService),this.settingsService=new Me(this.plugin,this.notificationService,this.errorService)}getAiApiService(e){switch(e){case d:return new de(this.errorService,this.notificationService,this.apiService,this.apiAuthService,this.apiResponseParser);case g:return new he(this.errorService,this.notificationService,this.apiService,this.apiAuthService,this.apiResponseParser);case u:return new ge(this.errorService,this.notificationService,this.apiService,this.apiAuthService,this.apiResponseParser);case f:return new fe(this.errorService,this.notificationService,this.apiService,this.apiAuthService,this.apiResponseParser);case S:return new Se(this.errorService,this.notificationService,this.apiService,this.apiAuthService,this.apiResponseParser);case v:return new ve(this.errorService,this.notificationService,this.apiService,this.apiAuthService,this.apiResponseParser);default:throw new Error(`Unknown AI service type: ${e}`)}}getFileService(){return this.fileService}getEditorContentService(){return this.editorContentService}getMessageService(){return this.messageService}getTemplateService(){return this.templateService}getFrontmatterManager(){return this.frontmatterManager}getFrontmatterService(){return this.frontmatterService}getEditorService(){return this.editorService}getNotificationService(){return this.notificationService}getErrorService(){return this.errorService}getApiService(){return this.apiService}getApiAuthService(){return this.apiAuthService}getApiResponseParser(){return this.apiResponseParser}getSettingsService(){return this.settingsService}};var H=require("obsidian");var ne=require("obsidian"),oe=class extends ne.SuggestModal{constructor(e,t,r,i=[]){super(e),this.modelNames=i,this.editor=t,this.editorService=r,this.limit=this.modelNames.length,this.modelNames.length>0?this.setPlaceholder("Select Large Language Model"):this.setPlaceholder("Loading available models...")}getSuggestions(e){return this.modelNames.filter(t=>t.toLowerCase().includes(e.toLowerCase()))}renderSuggestion(e,t){t.createEl("div",{text:e})}async onChooseSuggestion(e,t){if(!(this.modelNames.indexOf(e)===-1||this.modelNames.length===0)){new ne.Notice(`Selected model: ${e}`);try{await this.editorService.setModel(this.editor,e)}catch(r){new ne.Notice(`Error setting model: ${r.message}`)}}}};var _e=class{constructor(e,t,r){this.aiService=null;this.availableModels=[];this.plugin=e,this.serviceLocator=t,this.settingsService=r,this.statusBarItemEl=e.addStatusBarItem(),this.apiAuthService=new y}registerCommands(){this.registerChatCommand(),this.registerSelectModelCommand(),this.registerAddDividerCommand(),this.registerAddCommentBlockCommand(),this.registerStopStreamingCommand(),this.registerInferTitleCommand(),this.registerMoveToNewChatCommand(),this.registerChooseChatTemplateCommand(),this.registerClearChatCommand()}registerChatCommand(){this.plugin.addCommand({id:je,name:"Chat",icon:"message-circle",editorCallback:async(e,t)=>{var o;let r=this.serviceLocator.getEditorService(),i=this.settingsService.getSettings(),n=await r.getFrontmatter(t,i,this.plugin.app);this.aiService=this.serviceLocator.getAiApiService(n.aiService);try{let{messagesWithRole:s,messages:l}=await r.getMessagesFromEditor(e,i);i.generateAtCursor||r.moveCursorToEnd(e),H.Platform.isMobile?new H.Notice(`[ChatGPT MD] Calling ${n.model}`):this.updateStatusBar(`Calling ${n.model}`);let c=this.apiAuthService.getApiKey(i,n.aiService),p=await this.aiService.callAIAPI(s,n,K(i.headingLevel),this.getAiApiUrls(n)[n.aiService],e,i.generateAtCursor,c,i);if(r.processResponse(e,p,i),i.autoInferTitle&&ct((o=t==null?void 0:t.file)==null?void 0:o.basename,i.dateFormat)&&s.length>ot){let m={...n,openrouterApiKey:this.apiAuthService.getApiKey(i,u),url:this.getAiApiUrls(n)[n.aiService]};if(!m.model){if(n.aiService===d)m.model=h.model;else if(n.aiService===u)m.model=A.model;else if(n.aiService===S)m.model=M.model;else if(n.aiService===v)m.model=E.model;else if(n.aiService===g||n.aiService===f){new H.Notice(`Auto title inference skipped: No model configured for ${n.aiService}. Please set a model in settings.`,6e3);return}}await this.aiService.inferTitle(t,m,l,r)}}catch(s){H.Platform.isMobile&&new H.Notice(`[ChatGPT MD] Calling ${n.model}. `+s,9e3)}this.updateStatusBar("")}})}registerSelectModelCommand(){this.plugin.addCommand({id:"select-model-command",name:"Select Model",icon:"list",editorCallback:async(e,t)=>{let r=this.serviceLocator.getEditorService(),i=this.settingsService.getSettings(),n=new oe(this.plugin.app,e,r,this.availableModels);n.open(),(async()=>{try{let o=await r.getFrontmatter(t,i,this.plugin.app),s=this.apiAuthService.getApiKey(i,d),l=this.apiAuthService.getApiKey(i,u),c={[d]:o.openaiUrl||i.openaiUrl||h.url,[u]:o.openrouterUrl||i.openrouterUrl||A.url,[g]:o.ollamaUrl||i.ollamaUrl||b.url,[f]:o.lmstudioUrl||i.lmstudioUrl||C.url,[S]:o.anthropicUrl||i.anthropicUrl||M.url,[v]:o.geminiUrl||i.geminiUrl||E.url},p=await this.fetchAvailableModels(c,s,l),m=new Set(this.availableModels),T=new Set(p);(this.availableModels.length!==p.length||![...m].every(P=>T.has(P))||![...T].every(P=>m.has(P)))&&p.length>0&&(this.availableModels=p,n.close(),new oe(this.plugin.app,e,r,this.availableModels).open())}catch(o){}})()}})}registerAddDividerCommand(){this.plugin.addCommand({id:Be,name:"Add divider",icon:"minus",editorCallback:async(e,t)=>{let r=this.serviceLocator.getEditorService(),i=this.settingsService.getSettings();r.addHorizontalRule(e,N,i.headingLevel)}})}registerAddCommentBlockCommand(){this.plugin.addCommand({id:qe,name:"Add comment block",icon:"comment",editorCallback:(e,t)=>{let r=e.getCursor(),i=r.line,n=r.ch,o=`${tt}${D}${rt}`;e.replaceRange(o,r);let s={line:i+1,ch:n};e.setCursor(s)}})}registerStopStreamingCommand(){this.plugin.addCommand({id:We,name:"Stop streaming",icon:"octagon",callback:()=>{this.aiService&&"stopStreaming"in this.aiService?this.aiService.stopStreaming():this.serviceLocator.getNotificationService().showWarning("No active streaming request to stop")}})}registerInferTitleCommand(){this.plugin.addCommand({id:ze,name:"Infer title",icon:"subtitles",editorCallback:async(e,t)=>{let r=this.serviceLocator.getEditorService(),i=this.settingsService.getSettings(),n=await r.getFrontmatter(t,i,this.plugin.app);if(this.aiService=this.serviceLocator.getAiApiService(n.aiService),!n.model)return;this.updateStatusBar(`Calling ${n.model}`);let{messages:o}=await r.getMessagesFromEditor(e,i),s={...i,...n,openrouterApiKey:this.apiAuthService.getApiKey(i,u),url:this.getAiApiUrls(n)[n.aiService]};await this.aiService.inferTitle(t,s,o,r),this.updateStatusBar("")}})}registerMoveToNewChatCommand(){this.plugin.addCommand({id:Ye,name:"Create new chat with highlighted text",icon:"highlighter",editorCallback:async(e,t)=>{let r=this.serviceLocator.getEditorService(),i=this.settingsService.getSettings();try{await r.createNewChatWithHighlightedText(e,i)}catch(n){new H.Notice("[ChatGPT MD] Error in Create new chat with highlighted text, check console")}}})}registerChooseChatTemplateCommand(){this.plugin.addCommand({id:Je,name:"Create new chat from template",icon:"layout-template",callback:async()=>{let e=this.serviceLocator.getEditorService(),t=this.settingsService.getSettings();if(t.dateFormat){await e.createNewChatFromTemplate(t,e.getDate(new Date,t.dateFormat));return}new H.Notice("date format cannot be empty in your ChatGPT MD settings. You can choose something like YYYYMMDDhhmmss")}})}registerClearChatCommand(){this.plugin.addCommand({id:Xe,name:"Clear chat (except frontmatter)",icon:"trash",editorCallback:async(e,t)=>{await this.serviceLocator.getEditorService().clearChat(e)}})}getAiApiUrls(e){return{openai:e.openaiUrl||h.url,openrouter:e.openrouterUrl||A.url,ollama:e.ollamaUrl||b.url,lmstudio:e.lmstudioUrl||C.url,anthropic:e.anthropicUrl||M.url,gemini:e.geminiUrl||E.url}}async initializeAvailableModels(){try{let e=this.settingsService.getSettings(),t=this.apiAuthService.getApiKey(e,d),r=this.apiAuthService.getApiKey(e,u),i={[d]:e.openaiUrl||h.url,[u]:e.openrouterUrl||A.url,[g]:e.ollamaUrl||b.url,[f]:e.lmstudioUrl||C.url,[S]:e.anthropicUrl||M.url,[v]:e.geminiUrl||E.url};this.availableModels=await this.fetchAvailableModels(i,t,r)}catch(e){this.availableModels=[]}}async fetchAvailableModels(e,t,r){function i(n,o,s){return Promise.race([n,new Promise(l=>setTimeout(()=>l(s),o))])}try{let n=[];n.push(i(ft(e[g]),Y,[])),n.push(i(vt(e[f]),Y,[])),w(t)&&n.push(i(gt(e[d],t),Y,[])),w(r)&&n.push(i(St(e[u],r),Y,[]));let o=this.apiAuthService.getApiKey(this.settingsService.getSettings(),S);w(o)&&n.push(i(yt(e[S],o),Y,[]));let s=this.apiAuthService.getApiKey(this.settingsService.getSettings(),v);return w(s)&&n.push(i(Tt(e[v],s),Y,[])),(await Promise.all(n)).flat()}catch(n){return new H.Notice("Error fetching models: "+(n instanceof Error?n.message:String(n))),[]}}updateStatusBar(e){this.statusBarItemEl.setText(`[ChatGPT MD] ${e}`)}};var Ie=class extends Mt.Plugin{async onload(){this.serviceLocator=new Pe(this.app,this);let e=this.serviceLocator.getSettingsService();await e.loadSettings(),await e.migrateSettings(),await e.addSettingTab(),this.commandRegistry=new _e(this,this.serviceLocator,e),this.commandRegistry.registerCommands(),this.commandRegistry.initializeAvailableModels().catch(t=>{})}};

/* nosourcemap */